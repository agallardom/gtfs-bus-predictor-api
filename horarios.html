<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor de Buses GTFS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo base para el cuerpo y la fuente */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* Estilos espec√≠ficos para la est√©tica */
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .bus-line {
            background-color: #3b82f6; /* Tailwind blue-500 */
        }
        .bus-time {
            background-color: #10b981; /* Tailwind emerald-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
    <h1 id="horarios-titulo" class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">
        üöå Pr√≥ximos Horarios de Transporte
    </h1>
    
    <!-- NUEVA SECCI√ìN: Clave de Usuario -->
    <div id="key-section" class="bg-gray-50 p-5 rounded-lg border border-gray-200 shadow-inner mb-6">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">Clave de Usuario Personalizada</h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="user-key-input" placeholder="Introduce tu clave de usuario (ej: 'ANGEL')"
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
            <button onclick="saveUserKey()"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-105">
                Guardar Clave
            </button>
        </div>
        <p id="key-status" class="mt-2 text-sm text-gray-500"></p>
    </div>
    <!-- FIN NUEVA SECCI√ìN -->

    <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <!-- üõë IMPORTANTE: Aseg√∫rate de que esta URL es la correcta de tu servicio en Render üõë -->
        <input type="hidden" id="apiUrlBase" value="https://gtfs-bus-predictor-api.onrender.com/api/"> 
        
        <input 
            type="text" 
            id="groupName" 
            value="CASA" 
            placeholder="Introduce el nombre del grupo (ej: CASA)"
            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
        />
        <button 
            onclick="cargarHorarios(document.getElementById('groupName').value.trim())"
            id="fetchButton"
            class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50"
        >
            Consultar Grupo
        </button>

        <button 
            onclick="iniciarCargaDinamica()"
            id="geoButton"
            class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md disabled:opacity-50"
        >
            üìç Buscar Cercano
        </button>
    </div>

    <p id="statusMessage" class="text-sm text-red-500 mb-4"></p>

    <div id="resultsContainer" class="space-y-6">
        <p class="text-gray-500 text-center p-4">Introduce tu clave, un grupo o usa la Geolocalizaci√≥n.</p>
    </div>

    <p style="text-align: right; font-size: 0.8em; margin-top: 15px;">
        √öltima actualizaci√≥n: <span id="last-updated">--:--:--</span>
    </p>
</div>
 <script>
    // =======================================================================
    // VARIABLES GLOBALES Y UTILIDADES
    // =======================================================================
    const API_BASE_URL = document.getElementById('apiUrlBase').value;
    
    function formatMinutes(minutes) {
        if (minutes === 'N/A') return 'N/A';
        if (minutes === 0) return 'Ahora mismo';
        return `en ${minutes} min`;
    }

    function actualizarEstado(texto, isError = false) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.textContent = texto;
        statusElement.className = `text-sm mb-4 ${isError ? 'text-red-500' : 'text-gray-600'}`;
    }

    function actualizarTitulo(grupo, distancia = null) {
        let texto = `üöå Horarios de ${grupo}`;
        if (distancia !== null) {
             texto += ` (A ${distancia} km)`;
        }
        document.getElementById('horarios-titulo').innerHTML = texto;
    }

    function actualizarTiempo() {
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    }
    
    // =======================================================================
    // GESTI√ìN DE LA CLAVE DE USUARIO (NUEVO)
    // =======================================================================
    
    function getUserKey() {
        return localStorage.getItem('bus_predictor_user_key');
    }

    function saveUserKey() {
        const keyInput = document.getElementById('user-key-input');
        const key = keyInput.value.trim().toUpperCase();
        const keyStatus = document.getElementById('key-status');

        if (key) {
            localStorage.setItem('bus_predictor_user_key', key);
            keyStatus.textContent = `Clave '${key}' guardada correctamente.`;
            keyStatus.classList.remove('text-red-500');
            keyStatus.classList.add('text-green-600');
        } else {
            localStorage.removeItem('bus_predictor_user_key');
            keyStatus.textContent = "Clave eliminada. ¬°IMPORTANTE! Introduce y guarda tu clave.";
            keyStatus.classList.remove('text-green-600');
            keyStatus.classList.add('text-red-500');
        }
        // Asegurar que el input refleje la clave guardada o vac√≠a
        keyInput.value = key; 
    }

    function loadUserKeyStatus() {
        const storedKey = getUserKey();
        const keyInput = document.getElementById('user-key-input');
        const keyStatus = document.getElementById('key-status');

        if (storedKey) {
            keyInput.value = storedKey;
            keyStatus.textContent = `Clave activa: ${storedKey}.`;
            keyStatus.classList.remove('text-red-500');
            keyStatus.classList.add('text-green-600');
        } else {
            keyStatus.textContent = "¬°IMPORTANTE! Introduce y guarda tu clave de usuario para personalizar los grupos.";
            keyStatus.classList.remove('text-green-600');
            keyStatus.classList.add('text-red-500');
        }
    }


    // =======================================================================
    // RENDERIZADO
    // =======================================================================

    function renderResults(data) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = ''; 
        
        for (const stopId in data) {
            const stopData = data[stopId];
            
            if (stopData.error) {
                const errorCard = `<div class="card bg-red-100 p-4 rounded-lg border border-red-400"><h3 class="text-xl font-semibold text-red-700">üõë Parada: ${stopId}</h3><p class="text-red-600 mt-2">Error: ${stopData.error}</p></div>`;
                container.innerHTML += errorCard;
                continue;
            }


            let busItemsHTML = '';
            const horarios = stopData.horarios_ordenados || [];

            if (horarios.length === 0) {
                 busItemsHTML = `<p class="text-gray-500 italic p-3">No hay autobuses programados para el resto del d√≠a o fin de semana.</p>`;
            } else {
                busItemsHTML = horarios.map((bus, index) => {
                    const isSoon = bus.minutos_restantes !== 'N/A' && bus.minutos_restantes < 10;
                    // Usar un color secundario (√≠ndigo) si no est√° a punto de llegar
                    const bgColor = isSoon ? 'bg-red-500' : 'bg-indigo-600';

                    return `
                        <li class="flex justify-between items-center py-2 px-3 border-b last:border-b-0 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <div class="flex items-center space-x-3 w-1/3">
                                <span class="font-bold text-lg ${bgColor} text-white px-2 py-1 rounded-full min-w-[3rem] text-center">
                                    ${bus.linea}
                                </span>
                                <span class="text-gray-700 font-medium truncate" title="${bus.destino}">
                                    ${bus.destino}
                                </span>
                            </div>
                            <div class="flex-grow text-right font-mono text-gray-800 w-1/3">
                                ${bus.proximo_bus}
                            </div>
                            <div class="text-right w-1/3">
                                <span class="font-extrabold ${isSoon ? 'text-red-600' : 'text-green-700'} text-lg">
                                    ${formatMinutes(bus.minutos_restantes)}
                                </span>
                            </div>
                        </li>
                    `;
                }).join('');
            }

            const cardHTML = `
                <div id="stop-card-${stopId}" class="card bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <header class="bg-gray-800 text-white p-4">
                        <h2 class="text-xl font-extrabold">üìç ${stopData.nombre_parada}</h2>
                        <p class="text-sm text-gray-400">ID: ${stopId}</p>
                    </header>
                    <ul class="divide-y divide-gray-200 p-0 m-0">
                        <li class="flex justify-between items-center py-2 px-3 bg-gray-200 text-sm font-semibold text-gray-600">
                            <span class="w-1/3">L√≠nea/Destino</span>
                            <span class="flex-grow text-right w-1/3">Pr√≥x. Hora</span>
                            <span class="text-right w-1/3">Tiempo Restante</span>
                        </li>
                        ${busItemsHTML}
                    </ul>
                </div>
            `;
            container.innerHTML += cardHTML;
        }
    }


    // =======================================================================
    // FUNCIONES DE LLAMADA A LA API (MODIFICADAS)
    // =======================================================================

    /**
     * Llama a la API principal para obtener los horarios del grupo especificado.
     * @param {string} groupName - Nombre del grupo de paradas (ej. 'CASA').
     * @param {number | null} distance - Distancia en KM (opcional, solo para b√∫squeda geo).
     */
    async function cargarHorarios(groupName, distance = null) {
        const fetchButton = document.getElementById('fetchButton');
        const geoButton = document.getElementById('geoButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const userKey = getUserKey(); // OBTENER CLAVE

        if (!userKey) {
            actualizarEstado("‚ö†Ô∏è ERROR: Por favor, introduce y guarda tu Clave de Usuario primero.", true);
            return;
        }

        if (!groupName) {
            actualizarEstado("Por favor, introduce un nombre de grupo.");
            return;
        }
        
        actualizarEstado(`Consultando horarios para ${groupName}...`);
        
        fetchButton.disabled = true;
        geoButton.disabled = true;
        
        try {
            // A√ëADIMOS EL PAR√ÅMETRO 'key' A LA URL
            const url = `${API_BASE_URL}bus/${groupName}?user_key=${userKey}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                const errorMessage = data.error || response.statusText;
                throw new Error(errorMessage);
            }
            
            actualizarTitulo(groupName, distance); 
            actualizarEstado(`Consulta exitosa para el grupo '${groupName}'.`);
            renderResults(data);
            actualizarTiempo();

        } catch (error) {
            actualizarEstado(`‚ö†Ô∏è Error al consultar: ${error.message}.`, true);
            resultsContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
            console.error('Fetch Error:', error);
        } finally {
            fetchButton.disabled = false;
            geoButton.disabled = false;
        }
    }


    /**
     * Funci√≥n que usa la geolocalizaci√≥n para determinar qu√© grupo cargar.
     */
    function iniciarCargaDinamica() {
        const fetchButton = document.getElementById('fetchButton');
        const geoButton = document.getElementById('geoButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const userKey = getUserKey(); // OBTENER CLAVE

        if (!userKey) {
            actualizarEstado("‚ö†Ô∏è ERROR: Por favor, introduce y guarda tu Clave de Usuario primero.", true);
            return;
        }
        
        actualizarEstado("Buscando permiso de Geolocalizaci√≥n...");
        resultsContainer.innerHTML = `<div class="text-center text-gray-600 p-8">Esperando la ubicaci√≥n...</div>`;

        if (!navigator.geolocation) {
            actualizarEstado("ERROR: Geolocalizaci√≥n no soportada.", true);
            resultsContainer.innerHTML = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 p-4 rounded-lg">Tu dispositivo no soporta geolocalizaci√≥n. Usa la b√∫squeda manual.</div>`;
            return;
        }
        
        fetchButton.disabled = true;
        geoButton.disabled = true;

        navigator.geolocation.getCurrentPosition(
            async posicion => {
                const lat = posicion.coords.latitude;
                const lon = posicion.coords.longitude;
                
                actualizarEstado("Calculando grupo m√°s cercano...");
                
                try {
                    // A√ëADIMOS EL PAR√ÅMETRO 'key' A LA URL
                    const urlNearest = `${API_BASE_URL}nearest?lat=${lat}&lon=${lon}&key=${userKey}`;
                    const response = await fetch(urlNearest);
                    const data = await response.json();
                    
                    if (!response.ok) {
                         throw new Error(data.error || response.statusText);
                    }
                    
                    const grupoCercano = data.nearest_group;
                    const distancia = data.distance_km;
                    
                    // Actualizar el input con el grupo detectado
                    document.getElementById('groupName').value = grupoCercano;
                    
                    // Cargar los horarios del grupo detectado, pasando la distancia
                    cargarHorarios(grupoCercano, distancia);

                } catch (error) {
                    actualizarEstado(`ERROR: No se pudo encontrar el grupo. (${error.message})`, true);
                    resultsContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-lg">Error API: ${error.message}</div>`;
                    console.error("Error al buscar grupo cercano:", error);
                } finally {
                    fetchButton.disabled = false;
                    geoButton.disabled = false;
                }
            }, 
            error => {
                const msg = "Permiso de Geolocalizaci√≥n denegado o Timeout. Usa la b√∫squeda manual.";
                actualizarEstado(msg, true);
                resultsContainer.innerHTML = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 p-4 rounded-lg">${msg}</div>`;
                console.error("Error de geolocalizaci√≥n:", error);
                
                fetchButton.disabled = false;
                geoButton.disabled = false;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } 
        );
    }
    
    // Al cargar la p√°gina, limpia el estado y carga la clave si existe.
    window.onload = () => {
        loadUserKeyStatus();
        document.getElementById('groupName').value = 'CASA';
        actualizarEstado("Listo para consultar. Introduce un grupo o pulsa Buscar Cercano.");
    };

</script>
</body> 
</html>
