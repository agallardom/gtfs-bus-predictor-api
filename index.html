<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor de Buses GTFS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo base para el cuerpo y la fuente */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* Estilos específicos para la estética */
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .bus-line {
            background-color: #3b82f6; /* Tailwind blue-500 */
        }
        .bus-time {
            background-color: #10b981; /* Tailwind emerald-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">
            🚌 Próximos Horarios de Transporte
        </h1>

        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <!-- ⚠️ IMPORTANTE: REEMPLAZA ESTA URL CON TU URL REAL DE RENDER ⚠️ -->
            <input type="hidden" id="apiUrlBase" value="https://gtfs-bus-predictor-api.onrender.com/api/bus/">
            
            <input 
                type="text" 
                id="groupName" 
                value="CASA" 
                placeholder="Introduce el nombre del grupo (ej: CASA)"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
            />
            <button 
                onclick="fetchData()"
                id="fetchButton"
                class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"
            >
                Consultar Horarios
            </button>
        </div>

        <p id="statusMessage" class="text-sm text-red-500 mb-4"></p>

        <!-- Contenedor donde se mostrarán las tarjetas de las paradas -->
        <div id="resultsContainer" class="space-y-6">
            <p class="text-gray-500 text-center p-4">Introduce un grupo y consulta la API para ver los resultados aquí.</p>
        </div>

    </div>

    <script>
        // Función auxiliar para formatear los minutos restantes
        function formatMinutes(minutes) {
            if (minutes === 'N/A') return 'N/A';
            if (minutes === 0) return 'Ahora mismo';
            return `en ${minutes} min`;
        }

        // Función principal para obtener y mostrar datos
        async function fetchData() {
            const baseUrl = document.getElementById('apiUrlBase').value;
            const groupName = document.getElementById('groupName').value.trim();
            const resultsContainer = document.getElementById('resultsContainer');
            const statusElement = document.getElementById('statusMessage');
            const button = document.getElementById('fetchButton');

            if (!groupName) {
                statusElement.textContent = "Por favor, introduce un nombre de grupo (ej: CASA).";
                return;
            }

            const url = baseUrl + groupName;
            statusElement.textContent = 'Consultando API... Esto puede tardar unos segundos.';
            button.disabled = true;
            button.textContent = 'Cargando...';
            resultsContainer.innerHTML = `<div class="text-center text-gray-600 p-8">Cargando datos de ${groupName}...</div>`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    // Si el servidor devuelve un error (404, 500, etc.)
                    const errorMessage = data.error || response.statusText;
                    throw new Error(errorMessage);
                }
                
                statusElement.textContent = `Consulta exitosa para el grupo '${groupName}'.`;
                renderResults(data);

            } catch (error) {
                // Errores de red, CORS, o errores devueltos por la API
                statusElement.textContent = `⚠️ Error al consultar: ${error.message}.`;
                resultsContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
                console.error('Fetch Error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Consultar Horarios';
            }
        }

        // Función para renderizar el resultado en el DOM
        function renderResults(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = ''; // Limpiar resultados anteriores

            // Iterar sobre cada parada en el diccionario de resultados
            for (const stopId in data) {
                const stopData = data[stopId];
                
                // Si hay un error específico para esta parada (ej. ID no encontrado)
                if (stopData.error) {
                    const errorCard = `
                        <div class="card bg-yellow-100 p-4 rounded-lg border border-yellow-400">
                            <h3 class="text-xl font-semibold text-yellow-700">🛑 Parada: ${stopId}</h3>
                            <p class="text-yellow-600 mt-2">Error: ${stopData.error}</p>
                        </div>
                    `;
                    container.innerHTML += errorCard;
                    continue;
                }

                // Generar la tarjeta de la parada
                let busItemsHTML = '';
                const horarios = stopData.horarios_ordenados || [];

                if (horarios.length === 0) {
                     busItemsHTML = `<p class="text-gray-500 italic p-3">No hay autobuses programados para el resto del día o fin de semana.</p>`;
                } else {
                    // Mapear los horarios ordenados a elementos visuales
                    busItemsHTML = horarios.map((bus, index) => {
                        const isSoon = bus.minutos_restantes !== 'N/A' && bus.minutos_restantes < 10;
                        const bgColor = isSoon ? 'bg-red-500' : 'bg-green-600';

                        return `
                            <li class="flex justify-between items-center py-2 px-3 border-b last:border-b-0 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                <div class="flex items-center space-x-3 w-1/3">
                                    <span class="font-bold text-lg ${bgColor} text-white px-2 py-1 rounded-full min-w-[3rem] text-center">
                                        ${bus.linea}
                                    </span>
                                    <span class="text-gray-700 font-medium truncate" title="${bus.destino}">
                                        ${bus.destino}
                                    </span>
                                </div>
                                <div class="flex-grow text-right font-mono text-gray-800 w-1/3">
                                    ${bus.proximo_bus}
                                    ${bus.siguiente_bus !== 'N/A' ? `(${bus.siguiente_bus})` : ''}
                                </div>
                                <div class="text-right w-1/3">
                                    <span class="font-extrabold ${isSoon ? 'text-red-600' : 'text-green-700'} text-lg">
                                        ${formatMinutes(bus.minutos_restantes)}
                                    </span>
                                </div>
                            </li>
                        `;
                    }).join('');
                }

                const cardHTML = `
                    <div class="card bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <header class="bg-gray-800 text-white p-4">
                            <h2 class="text-xl font-extrabold">📍 ${stopData.nombre_parada}</h2>
                            <p class="text-sm text-gray-400">ID: ${stopId}</p>
                        </header>
                        <ul class="divide-y divide-gray-200 p-0 m-0">
                            <li class="flex justify-between items-center py-2 px-3 bg-gray-200 text-sm font-semibold text-gray-600">
                                <span class="w-1/3">Línea/Destino</span>
                                <span class="flex-grow text-right w-1/3">Próx. Hora (Sig.)</span>
                                <span class="text-right w-1/3">Tiempo Restante</span>
                            </li>
                            ${busItemsHTML}
                        </ul>
                    </div>
                `;
                container.innerHTML += cardHTML;
            }
        }
    </script>
</body> 
</html>
